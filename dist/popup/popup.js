import{O as k}from"../chunks/index-C7sbpHLK.js";function o(t){const e=document.getElementById(t);if(!e)throw new Error(`Element with id '${t}' not found`);return e}function b(t){const e=document.querySelector(t);if(!e)throw new Error(`Element with selector '${t}' not found`);return e}document.addEventListener("DOMContentLoaded",()=>{h(),o("add-bookmark").addEventListener("click",y),o("cancel-add-bookmark").addEventListener("click",m),o("add-bookmark-form").addEventListener("submit",f),o("save-settings").addEventListener("click",w),o("github-sync-enabled").addEventListener("change",S),o("test-connection").addEventListener("click",C),o("sync-now").addEventListener("click",L)});function h(){chrome.storage.sync.get(["bookmarks","searchEngine","githubSync"],t=>{if(t.bookmarks&&d(t.bookmarks),t.searchEngine){const e=document.querySelector(`input[name="search-engine"][value="${t.searchEngine}"]`);e&&(e.checked=!0)}if(t.githubSync){const e=o("github-sync-enabled"),n=o("github-sync-config"),s=o("github-token");e.checked=t.githubSync.enabled,s.value=t.githubSync.token||"",t.githubSync.enabled?(n.style.display="block",l("idle","已启用GitHub同步")):n.style.display="none"}})}function d(t){const e=o("bookmark-list");e.innerHTML="",t.forEach((n,s)=>{const c=document.createElement("div");c.className="bookmark-item";const r=document.createElement("div");r.className="bookmark-info";const i=document.createElement("img");i.className="bookmark-icon",i.src=n.icon||`https://www.google.com/s2/favicons?domain=${n.url}`,i.alt="";const a=document.createElement("span");a.className="bookmark-title",a.textContent=n.title,r.appendChild(i),r.appendChild(a);const g=document.createElement("div");g.className="bookmark-actions";const u=document.createElement("button");u.className="bookmark-action",u.textContent="删除",u.addEventListener("click",()=>p(s)),g.appendChild(u),c.appendChild(r),c.appendChild(g),e.appendChild(c)})}function y(){o("add-bookmark-dialog").classList.add("active")}function m(){o("add-bookmark-dialog").classList.remove("active"),o("add-bookmark-form").reset()}function f(t){t.preventDefault();const e=o("bookmark-title"),n=o("bookmark-url"),s=e.value.trim();let c=n.value.trim();!c.startsWith("http://")&&!c.startsWith("https://")&&(c="https://"+c),chrome.storage.sync.get("bookmarks",r=>{const i=r.bookmarks||[],a={title:s,url:c,icon:`https://www.google.com/s2/favicons?domain=${c}`};i.push(a),chrome.storage.sync.set({bookmarks:i},()=>{d(i),m()})})}function p(t){chrome.storage.sync.get("bookmarks",e=>{const n=e.bookmarks||[];n.splice(t,1),chrome.storage.sync.set({bookmarks:n},()=>{d(n)})})}function w(){const e=b('input[name="search-engine"]:checked').value;chrome.storage.sync.set({searchEngine:e},()=>{const n=o("save-settings"),s=n.textContent||"保存设置";n.textContent="已保存",n.disabled=!0,setTimeout(()=>{n.textContent=s,n.disabled=!1},1500)})}let E="idle";function S(){const t=o("github-sync-enabled").checked,e=o("github-sync-config");t?(e.style.display="block",v()):(e.style.display="none",chrome.storage.sync.set({githubSync:{enabled:!1}}))}function v(){chrome.storage.sync.get(["githubSync"],t=>{const e=t.githubSync;e&&(o("github-sync-enabled").checked=e.enabled,o("github-token").value=e.token||"",e.enabled&&(o("github-sync-config").style.display="block"))})}async function C(){const e=o("github-token").value.trim();if(!e){l("error","请输入GitHub Token");return}try{l("syncing","正在测试连接...");const s=await new k({auth:e}).rest.users.getAuthenticated();l("success",`连接成功，用户: ${s.data.login}`),chrome.storage.sync.set({githubSync:{token:e,enabled:!0}})}catch(n){l("error",`连接失败: ${n.message}`)}}async function L(){const t=o("github-token").value.trim();if(!t){l("error","请先设置GitHub Token");return}try{l("syncing","正在同步...");const e=await B(),n=await I(t);await N(t,n,e),l("success","同步完成")}catch(e){l("error",`同步失败: ${e.message}`)}}function B(){return new Promise(t=>{chrome.storage.sync.get(["bookmarks","searchEngine","workspaces","currentWorkspace"],e=>{t({bookmarks:e.bookmarks||[],searchEngine:e.searchEngine||"baidu",workspaces:e.workspaces||{},currentWorkspace:e.currentWorkspace||"default",lastSync:new Date().toISOString()})})})}async function I(t){const e=new k({auth:t}),c=(await e.rest.gists.list()).data.find(i=>i.files&&"mytab-config.json"in i.files);return c?c.id:(await e.rest.gists.create({description:"MyTab Extension Configuration",public:!1,files:{"mytab-config.json":{content:JSON.stringify({bookmarks:[],searchEngine:"baidu",theme:"light",workspaces:{},currentWorkspace:"default"},null,2)}}})).data.id}async function N(t,e,n){const s=new k({auth:t}),r=(await s.rest.gists.get({gist_id:e})).data.files["mytab-config.json"]?.content;let i;r?i=JSON.parse(r):i=n;const a=T(n,i);chrome.storage.sync.set({bookmarks:a.bookmarks,searchEngine:a.searchEngine,theme:a.theme,workspaces:a.workspaces,currentWorkspace:a.currentWorkspace,githubSync:{token:t,enabled:!0,gistId:e}}),await s.rest.gists.update({gist_id:e,files:{"mytab-config.json":{content:JSON.stringify(a,null,2)}}}),d(a.bookmarks),x()}function T(t,e){const n=new Date(t.lastSync||"1970-01-01").getTime(),s=new Date(e.lastSync||"1970-01-01").getTime();return n>s?{...t,lastSync:new Date().toISOString()}:{...e,lastSync:new Date().toISOString()}}function l(t,e){E=t;const n=o("sync-status-text");n.textContent=e,n.className=`sync-status-${t}`;const s=o("test-connection"),c=o("sync-now");t==="syncing"?(s.disabled=!0,c.disabled=!0):(s.disabled=!1,c.disabled=!1)}function x(){const t=o("last-sync-time"),e=new Date;t.textContent=`最后同步: ${e.toLocaleString("zh-CN")}`}
//# sourceMappingURL=popup.js.map
